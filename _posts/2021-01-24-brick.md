---
layout: post
title:  "μ½”λ“ ν•μ¤„λ΅ μ•λ“λ΅μ΄λ“ SharedPreferenceλ¥Ό μ•”νΈν™”ν•λ” λ°©λ²•"
feature-img: "assets/img/post/20210124_thumb.png"
thumbnail: "assets/img/post/20210124_thumb.png"
description: "μ•λ“λ΅μ΄λ“ SharedPreferences λ°μ΄ν„°λ¥Ό μ•”νΈν™” ν•μ—¬ λ³΄μ• μ„ν‘μΌλ΅λ¶€ν„° μ§€ν‚¤λ” λ°©λ²•μ„ μ†κ°ν•©λ‹λ‹¤."
date:   2021-1-24 12:42:00 +0900
categories: Android, Security
---

> λ‹Ήμ‹ μ μ•λ“λ΅μ΄λ“ μ•± λ°μ΄ν„°λ” μ•μ „ν•κ°€μ”?

# π” λ°μ΄ν„°λ¥Ό μ €μ¥ν•  λ• λ°λ“μ‹ μ•”νΈν™”κ°€ ν•„μ”ν•©λ‹λ‹¤.

![security]({{ "/assets/img/post/20210124_01.jpeg" | relative_url}})

[KISAμ κ°μΈμ •λ³΄ μ•μ „μ„± ν™•λ³΄μ΅°μΉ κΈ°μ¤€](https://www.kisa.or.kr/public/laws/laws3_View.jsp?cPage=1&mode=view&p_No=259&b_No=259&d_No=101&ST=T&SV=)μ— λ”°λ¥΄λ©΄ <br/>
μ£Όλ―Όλ²νΈλ‚ λΉ„λ°€λ²νΈμ™€ κ°™μ€ κ°μΈ μ •λ³΄λ¥Ό λ¨λ°”μΌ λ‹¨λ§μ— μ €μ¥ν•  λ•λ” λ°λ“μ‹ λ¨λ‘ μ•”νΈν™” ν•΄μ•Όν•©λ‹λ‹¤.<br/>
<br/>
λ§μ•½ λ³΄μ•μ— λ―Όκ°ν• μ„λΉ„μ¤λΌμ„ λ¨λ°”μΌ λ³΄μ• μ·¨μ•½μ  κ²€μ‚¬λ¥Ό λ°›λ”λ‹¤λ©΄<br/>
μ„μ— μ„μ λ λ―Όκ°ν• μ •λ³΄ λΏ μ•„λ‹λΌ μ „ν™”λ²νΈ, μƒλ…„μ›”μΌ, μ΄λ¦„ λ“±μ„ ν¬ν•¨ν•<br/>
μ‚¬μ‹¤μƒ κ±°μ λ¨λ“  μ •λ³΄λ¥Ό μ•”νΈν™” ν•΄μ•Όν•©λ‹λ‹¤.<br/>

λ”°λΌμ„ λ‹¨λ§μ— μ €μ¥ν•λ” λ°μ΄ν„°λ” **μ „λ¶€ μ•”νΈν™”**ν•λ” κ²ƒμ΄ μ •μ‹ κ±΄κ°•μ— μ΄λ΅­μµλ‹λ‹¤.<br/>
μ• μ΄λ¶€ν„° μ•”νΈν™” ν•λ” μµκ΄€μ„ λ“¤μ΄λ©΄ λ”λ”μ± μΆ‹κµ¬μ” π‘<br/>
<br/>

# π‘®β€β™‚οΈ EncryptedSharedPreferences


![jetpack]({{ "/assets/img/post/20210124_jetpack.png" | relative_url}})

Android Jetpackμ— ν¬ν•¨λ [EncryptedSharedPreferences](https://developer.android.com/reference/androidx/security/crypto/EncryptedSharedPreferences)λ¥Ό μ΄μ©ν•λ©΄<br/>
λ³µμ΅ν• κµ¬ν„ μ—†μ΄λ„ μ†μ‰½κ² **SharedPreferences λ°μ΄ν„°λ¥Ό μ•”νΈν™”**ν•  μ μμµλ‹λ‹¤. <br/>
~~κ°“λ“λ΅μ΄λ“ν‚ΉνΈν©~~<br/>
<br/>
λΉ„λ΅ μ•νλ²„μ „μ΄λ‚ μ‚¬μ‹¤μƒ κµ¬κΈ€ κ³µμ‹ λΌμ΄λΈλ¬λ¦¬λΌμ„ μ•μ‹¬ν•κ³  μ‚¬μ©ν•  μ μκ³ <br/>
κΈ°μ΅΄μ SharedPreferencesλ¥Ό μƒμ†λ°›κ³  μμ–΄μ„ μ²μ νΈμ¶ν•λ” λ¶€λ¶„λ§ μμ •ν•λ©΄<br/>
μ΄ν›„μ— λ°μ΄ν„°λ¥Ό μ½κ³  μ“°λ” κ³Όμ •μ—μ„μ μμ •μ€ μ•„μ μ—†κΈ° λ–„λ¬Έμ— λ¬΄μ²™ νΈλ¦¬ν•©λ‹λ‹¤.<br/>
<br/>
μ‹¤μ λ΅ μ‚¬μ©ν•΄λ³΄λ©΄ ν‚¤κ°’κ³Ό λ°μ΄ν„°κ°€ λ¨λ‘ μ•”νΈν™” λλ” κ²ƒμ„ ν™•μΈν•μ‹¤ μ μμµλ‹λ‹¤.<br/>
<br/>
κ·ΈλΌ ν•λ² μ§μ ‘ μ μ©ν•΄λ³ΌκΉμ”?<br/>

<br/><br/>

## 1. build.gradle(app)μ— μμ΅΄μ„± μ¶”κ°€ 

``` groovy
dependencies {
    implementation 'androidx.security:security-crypto:1.0.0-alpha02'
}
```

app μμ¤€μ `build.gradle` μ dependenciesμ— μ¶”κ°€ν•΄μ£Όλ©΄ λ©λ‹λ‹¤.<br/>

## 2. μ½”λ“μƒμ—μ„ EncryptedSharedPreferencesλ¥Ό νΈμ¶ν•κΈ°

```kotlin
  val masterKeyAlias = MasterKeys.getOrCreate(MasterKeys.AES256_GCM_SPEC)

  val sharedPreferences = EncryptedSharedPreferences.create(
      "secret_shared_prefs", // νμΌμ΄λ¦„μ„ μ…λ ¥ν•μ„Έμ”
      masterKeyAlias,
      context,
      EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
      EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
  )

  val editor: SharedPreferences.Editor = sharedPreferences.edit()
```

`EncryptedSharedPreferences`κ°€ μ΄λ―Έ SharedPreferences μ΄λ―€λ΅ μ΄ν›„μ—λ” <br/>
κΈ°μ΅΄μ— μ‰μ–΄λ“ν”„λ¦¬νΌλ°μ¤λ¥Ό μ‚¬μ©ν•λ κ³³μ—μ„ λ°μ΄ν„°λ¥Ό μ½κ³  μ“°λ” μ½”λ“λ” λ™μΌν•λ―€λ΅<br/>
λ³„λ„μ μ½”λ“ μμ • μ—†μ΄ κΈ°μ΅΄μ— μ‚¬μ©ν•μ‹λ λ€λ΅ μ‚¬μ©ν•λ©΄ λ©λ‹λ‹¤.<br/><br/>
<br/>



# π¤” κ·Έλ°λ° λ§μ…λ‹λ‹¤

`EncryptedSharedPreferences`λ¥Ό μ μ©ν•κ³ λ‚μ„ μ €μ¥ν• λ¨λ“  λ°μ΄ν„°λ” μ•”νΈν™” λκ² μ§€λ§<br/>
μ΄λ―Έ ν‰λ¬ΈμΌλ΅ μ €μ¥λ λ°μ΄ν„°λ¥Ό μ•”νΈν™” ν•΄μ£Όμ§€λ” μ•μµλ‹λ‹¤ π­<br/>

κ·Έλ¦¬κ³  μ•νƒ€κΉκ²λ„ λ³΄ν†µ μ΄ κΈ€μ„ μ½κ³  κ³„μ‹ λ¶„μ΄λΌλ©΄ <br/>
μ΄λ―Έ λ°°ν¬λμ–΄ μ‚¬μ©μ λ‹¨λ§μ— μ €μ¥λ λ°μ΄ν„°μ μ•”νΈν™”κ°€ ν•„μ”ν•μ‹  λ¶„λ“¤μ΄ λ§μΌμ‹¤ κ²ƒ κ°™μµλ‹λ‹¤.<br/>
<br/>
μ΄λ―Έ λ°°ν¬λ μ•±μ΄λΌμ„ μ‚¬μ©μκ°€ λ°μ΄ν„°λ¥Ό ν‰λ¬ΈμΌλ΅ μ €μ¥ν•κ³  μλ‹¤λ©΄<br/>
μ΄ **μ €μ¥λ λ°μ΄ν„°λ¥Ό μ „λ¶€ μ•”νΈν™” ν•λ” μ΄κ΄€μ‘μ—…**μ΄ λ°λ“μ‹ ν•„μ”ν•©λ‹λ‹¤.<br/>
<br/><br/>
μ—¬λ¬κ°€μ§€ λ°©λ²•μ΄ μμ„ μ μκ² μ§€λ§ μ΄ κΈ€μ—μ„λ” κ°€μ¥ κ°„λ‹¨ν•

1. κΈ°μ΅΄ λ°μ΄ν„°λ¥Ό μ‚­μ ν•κ³ 
2. μƒλ΅μ΄ νμΌμ— μ•”νΈν™” ν•΄μ„ λ³µμ‚¬ 

ν•λ” λ°©λ²•μ„ μ†κ°λ“λ¦¬κ² μµλ‹λ‹¤.<br/>
<br/>
<br/>

## π“¨ κΈ°μ΅΄ λ°μ΄ν„° μ΄κ΄€ν•κΈ°

κΈ°μ΅΄μ— μ΄λ―Έ μ‚¬μ©ν•κ³  μλ” λ°μ΄ν„°λ¥Ό μ•”νΈν™” ν•λ” λ¬Έμ λ” λ λ³„κ°μ λ¬Έμ μ…λ‹λ‹¤<br/>
<br/>
κ°€μ¥ κ°„λ‹¨ν• λ°©λ²•μ€ κΈ°μ΅΄μ λ°μ΄ν„°λ¥Ό μ „λ¶€ μ•”νΈν™”ν•μ—¬ λ³µμ‚¬ν•κ³  κΈ°μ΅΄μ λ°μ΄ν„°λ¥Ό μ‚­μ ν•μ—¬ <br/>
λ¬΄μ΅°κ±΄ μ•”νΈν™” λ λ°μ΄ν„°λ§ μ ‘κ·Όν•λ„λ΅ ν•λ” λ°©μ‹μ…λ‹λ‹¤.<br/>
<br/>

> β οΈ λ³µμ‚¬ν•κ³  κΈ°μ΅΄ λ°μ΄ν„°λ¥Ό μ‚­μ ν•λ” λ°©μ‹μ΄λ―€λ΅ μ•”νΈν™” ν•  νμΌμ΄λ¦„κ³Ό κΈ°μ΅΄ νμΌμ΄λ¦„μ€ λ‹¬λΌμ•Ό ν•©λ‹λ‹¤.


```kotlin
// μ•”νΈν™” λμ§€ μ•μ€ λ κ±°μ‹ λ°μ΄ν„°
val legacy = SharedPreferences by mContext.getSharedPreferences(mFile, Context.MODE_PRIVATE)
val entries = legacy.all.entries

// λ¨λ“  λ°μ΄ν„°λ¥Ό λ³µμ‚¬ν•λ‹¤.
// editorλ” EncryptedSharedPreferencesμ editor 
entries.forEach {
    when (it.value) {
        is String -> editor.putString(it.key, it.value as String).apply()
        is Long -> editor.putLong(it.key, it.value as Long).apply()
        is Int -> editor.putInt(it.key, it.value as Int).apply()
        is Float -> editor.putFloat(it.key, it.value as Float).apply()
        is Boolean -> editor.putBoolean(it.key, it.value as Boolean).apply()
        is Set<*> -> editor.putStringSet(it.key, it.value as Set<String>).apply()
    }
}
```

λ³µμ‚¬λ¥Ό λ‹¤ν–λ‹¤λ©΄ κΈ°μ΅΄μ ν‰λ¬Έ λ°μ΄ν„°λ¥Ό μ „λ¶€ μ§€μ›λ²„λ¦½μ‹λ‹¤.<br/>

```kotlin
legacy.edit().clear().apply()
```

<br/><br/><br/>

## κ·Έλ°λ° μ κΉ, μµμ†μ§€μ›μ΄ api23 μ΄λΌκµ¬μ”? π± π± π± 

![no_please_no]({{ "/assets/img/post/20210124_no.gif" | relative_url}})

λ„¤ κ·Έλ ‡μµλ‹λ‹¤. <br/>
λ§μ‹λ©λ΅μ΄ν•λ” μ΄ λ°©λ²•μΌλ΅λ” ν•  μ κ°€ μ—†κΈ° λ•λ¬Έμ—<br/>
κ²°κµ­ μƒλ΅μ΄ μ•”νΈν™” λ¨λ“μ„ λ§λ“¤μ–΄μ„ κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤.π±<br/><br/>

λ¬Έμ λ” μ•„μ§κΉμ§€λ„ λ§μ€ μ•±λ“¤μ 23λ―Έλ§μ μ•±μ„ μ§€μ›ν•κ³  μκΈ° λ•λ¬Έμ—<br/>
κΈ°κ» EncryptedSharedPreferencesκ°€ μμ–΄λ„ ν™μ©ν•κΈ°κ°€ μ–΄λ µλ‹¤λ” μ μ΄ κ°€μ¥ ν° λ¬Έμ μ…λ‹λ‹¤.<br/><br/>



## π¤·β€β™‚οΈ κ·ΈλΌ μ΄μ  μ–΄λ–΅ν•μ£ ?

μ•„μ§ λ°©λ²•μ΄ μμµλ‹λ‹¤. <br/>

[BrickSharedPreferences](https://github.com/HaenaraShin/BrickSharedPreference)λ¥Ό μ‚¬μ©ν•΄λ³΄μ„Έμ”!<br/><br/>


# BrickSharedPreferencesκ°€ λ­”λ°?

![BrickSharedPreferences]({{ "/assets/img/post/20210124_brick.png" | relative_url}})

<br/>

#### Api λ λ²¨ μƒκ΄€ μ—†μ΄ SharedPreferencesλ¥Ό μ•”νΈν™”ν•΄μ£Όλ” λΌμ΄λΈλ¬λ¦¬ μ…λ‹λ‹¤.

minSdk 14λ΅ λ‚®μ€ λ λ²¨κΉμ§€ μ§€μ›ν•λ©°<br/>
23 μ΄μƒμ΄λΌλ©΄ μ νΈν©μ EncryptedSharedPreferencesλ¥Ό μ‚¬μ©ν•κ³ <br/>
23 λ―Έλ§μ΄λΌλ©΄ μ»¤μ¤ν…€ μ•”νΈν™” SharedPreferencesλ¥Ό μ΄μ©ν•λ” λ³΄μ• λΌμ΄λΈλ¬λ¦¬ μ…λ‹λ‹¤.<br/>

λν• μ¶”κ°€λ΅ μ„μ—μ„ μ„¤λ…ν• 'κΈ°μ΅΄ λ°μ΄ν„° μ΄κ΄€'μ„ **λ‹¨ ν•μ¤„λ΅ ν•΄κ²°ν•  μ μμµλ‹λ‹¤.**<br/><br/>

## 1. build.gradle(app)μ— μμ΅΄μ„± μ¶”κ°€ 

```kotlin
dependencies {
    implementation 'dev.haenara:bricksharedpref:1.0.2'
    implementation 'androidx.security:security-crypto:1.0.0-alpha02'
}
```


## 2. μ½”λ“μƒμ—μ„ BrickSharedPreferencesλ¥Ό νΈμ¶ν•κΈ°


```kotlin 
// κΈ°μ΅΄ SharedPreferencesλ¥Ό κ°€μ Έμ¤λ” λ°©λ²•μ— "Brick"λ§ μ•μ— λ¶™μ΄λ©΄ λλ‹¤. 
val mSharedPreferences = getBrickSharedPreferences(fileName, Context.MODE_PRIVATE)
```

κΈ°μ΅΄μ— μ‰μ–΄λ“ν”„λ¦¬νΌλ°μ¤ νΈμ¶ μ‹μ— μ½”ν‹€λ¦°μ—μ„ μ‚¬μ©ν•λ μ½”λ“μ™€ κ±°μ μ μ‚¬ν•λ°, <br/>
`getSharedPreferences`λ¥Ό<br/> 
`getBrickSharedPreferences`λ΅ κ³ μΉ κ²ƒμ΄ μ „λ¶€μ…λ‹λ‹¤.<br/>

BrickSharedPreferencesλ„ κΈ°μ΅΄μ— μ‰μ–΄λ“ν”„λ¦¬νΌλ°μ¤λ¥Ό μ‚¬μ©ν•λ κ³³μ—μ„ λ°μ΄ν„°λ¥Ό μ½κ³  μ“°λ” μ½”λ“λ” λ™μΌν•λ―€λ΅<br/>
λ³„λ„μ μ½”λ“ μμ • μ—†μ΄ κΈ°μ΅΄μ— μ‚¬μ©ν•μ‹λ λ€λ΅ μ‚¬μ©ν•λ©΄ λ©λ‹λ‹¤.<br/><br/>
<br/>

## 3. κΈ°μ΅΄ λ°μ΄ν„° μ΄κ΄€ν•κΈ°

#### λ‹¨ ν•μ¤„μ΄λ©΄ λ©λ‹λ‹¤.

```kotlin
// μ €μ¥λμ–΄ μλ” λ°μ΄ν„°λ¥Ό μ „λ¶€ μ•”νΈν™”
mSharedPreferences.migrateEncryptedSharedPreferences()
```

μ”κ±° ν•μ¤„μ΄λ©΄ ν•΄κ²°λ©λ‹λ‹¤.

![sample_run]({{ "/assets/img/post/20210124_ma1.jpg" | relative_url}})
<br/>
![sample_run]({{ "/assets/img/post/20210124_ma2.jpg" | relative_url}})
<br/>
![sample_run]({{ "/assets/img/post/20210124_ma3.jpeg" | relative_url}})
<br/>
![sample_run]({{ "/assets/img/post/20210124_ma4.jpeg" | relative_url}})

<br/>

λ‹¨, λ§μ•½ SharedPreferencesλ¥Ό μ—¬λ¬ νμΌλ΅ λ‚λ„μ–΄ μ‚¬μ©μ¤‘μ΄λΌλ©΄<br/>
κ°κ° νμΌλ³„λ΅ λ§μ΄κ·Έλ μ΄μ…μ„ νΈμ¶ν•΄μ¤μ•Ό ν•©λ‹λ‹¤.<br/>

μ΄κ΄€ μ‘μ—…μ€ μ•± μ‹¤ν–‰ μ‹ λ”± ν•λ²λ§ νΈμ¶ν•΄μ£Όλ©΄ λκΈ° λ•λ¬Έμ— <br/>
Application classμ onCreate() μ—μ„ νΈμ¶ν•΄μ£Όλ” κ²ƒμ΄ κ°€μ¥ μΆ‹μµλ‹λ‹¤.<br/>

<br/><br/>

## 4. μ‹¤ν–‰ μμ 

![sample_run]({{ "/assets/img/post/20210124_sample_run.gif" | relative_url}})

[BrickSharedPreferences λ ν¬μ§€ν† λ¦¬](https://github.com/HaenaraShin/BrickSharedPreference)μ— μμ„Έν•κ² μ„¤λ…λμ–΄ μμΌλ‹ <br/>

ν•„μ”ν•μ‹λ‹¤λ©΄ μƒν” μ•±κ³Ό μ½”λ“λ¥Ό μ°Έκ³ ν•΄λ³΄μ‹λ” κ²ƒλ„ μΆ‹μ„ κ²ƒ κ°™μµλ‹λ‹¤π‘<br/>

<br/><br/><br/>

# π€ κ²°λ΅ 

λ¨λ°”μΌ λ‹¨λ§μ— μ €μ¥ν•λ” λ¨λ“  λ°μ΄ν„°λ” μ•”νΈν™” ν•΄μ•Όν•©λ‹λ‹¤.<br/>
BrickSharedPreferencesλ¥Ό μ΄μ©ν•΄μ„ κ°„νΈν•κ² λ°μ΄ν„°λ¥Ό μ•”νΈν™” ν•΄λ³΄μ„Έμ”.<br/>
λ§μ•½ μ μ©ν•κ² μ“°μ…¨λ‹¤λ©΄ κΉƒν—™μ—μ„ **β­οΈμ¤νƒ€**λ¥Ό λλ¬μ£Όμ„Έμ” π‘<br/>

# λ νΌλ°μ¤

- [EncryptedSharedPreferences - κµ¬κΈ€ Android Developer](https://developer.android.com/reference/kotlin/androidx/security/crypto/EncryptedSharedPreferences)
- [BrickSharedPreferences](https://github.com/HaenaraShin/BrickSharedPreference)

<br/><br/>